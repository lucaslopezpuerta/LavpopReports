<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lavpop Data Tables - Master Files</title>
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
    
    <!-- jQuery and DataTables JS -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

    <style>
        /* Inherit styles from main dashboard */
        :root {
            --primary-blue: #10306b;
            --secondary-blue: #1a4798;
            --accent-green: #6bbe4c;
            --light-green: #2ae01e;
            --background-light: #f8fafc;
            --background-white: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-light: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--background-light) 0%, #e2e8f0 100%);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .header {
            background: #020024;
            background: linear-gradient(90deg, rgba(2, 0, 36, 1) 0%, rgba(9, 9, 121, 1) 40%, rgba(42, 224, 30, 1) 100%);
            padding: 2rem 0;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
        }

        .logo {
            max-width: 120px;
            height: auto;
            margin-bottom: 1rem;
            filter: brightness(1.1);
        }

        .header h1 {
            color: white;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem 2rem;
        }

        .table-section {
            background: var(--background-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        .table-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-light);
            background: linear-gradient(135deg, var(--background-white) 0%, #f8fafc 100%);
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .table-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin: 0;
        }

        .table-content {
            padding: 2rem;
        }

        .table-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: var(--background-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            color: var(--text-secondary);
        }

        .tab-button.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .tab-button:hover:not(.active) {
            background: var(--border-light);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border-light);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 2rem;
            color: #dc2626;
            background: #fef2f2;
            border-radius: var(--radius-md);
            border: 1px solid #fecaca;
        }

        /* Custom DataTables styling */
        .dataTables_wrapper {
            font-family: inherit;
        }

        .dataTables_filter input {
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: 0.5rem;
            margin-left: 0.5rem;
        }

        .dataTables_length select {
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: 0.25rem;
            margin: 0 0.5rem;
        }

        table.dataTable {
            border-collapse: collapse;
            border-spacing: 0;
            width: 100%;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
        }

        table.dataTable thead th {
            background: var(--primary-blue);
            color: white;
            padding: 1rem;
            font-weight: 600;
            border-bottom: none;
            text-align: center;
        }

        table.dataTable tbody td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-light);
            text-align: center;
        }

        table.dataTable tbody tr:hover {
            background: var(--background-light);
        }

        .dt-buttons {
            margin-bottom: 1rem;
        }

        .dt-button {
            background: var(--secondary-blue) !important;
            color: white !important;
            border: none !important;
            padding: 0.5rem 1rem !important;
            border-radius: var(--radius-sm) !important;
            margin-right: 0.5rem !important;
            font-size: 0.875rem !important;
        }

        .dt-button:hover {
            background: var(--primary-blue) !important;
        }

        /* Summary Stats Panel */
        .stats-panel {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: var(--radius-lg);
            border: 1px solid #0ea5e9;
        }

        .stat-card {
            background: var(--background-white);
            padding: 1rem;
            border-radius: var(--radius-md);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Quick Filters */
        .quick-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .quick-filter-btn {
            padding: 0.5rem 1rem;
            background: var(--background-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .quick-filter-btn:hover, .quick-filter-btn.active {
            background: var(--secondary-blue);
            color: white;
            border-color: var(--secondary-blue);
        }

        /* Column highlighting */
        .column-highlight {
            background: #fef3c7 !important;
        }

        /* Filter toggle */
        .filter-toggle {
            background: var(--accent-green);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .filter-toggle:hover {
            background: var(--light-green);
        }

        /* Row selection */
        .select-checkbox {
            cursor: pointer;
        }

        .selected-row {
            background: #dbeafe !important;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .main-content {
                padding: 0 1rem 1rem;
            }
            
            .table-content {
                padding: 1rem;
            }
            
            .table-tabs {
                gap: 0.25rem;
            }
            
            .tab-button {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <img src="https://lavpop.com.br/assets/web/images/logos/logo-lavpop-site@2x.png" alt="Lavpop Logo" class="logo">
            <h1>Data Tables</h1>
            <p>Master files and analytics data</p>
            <a href="index.html" class="back-button">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
                </svg>
                Back to Dashboard
            </a>
        </div>
    </header>

    <main class="main-content">
        <div class="table-section">
            <div class="table-header">
                <h2 class="table-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 3v18h18V3H3zm16 16H5V5h14v14zM7 7h2v2H7zM11 7h6v2h-6zM7 11h2v2H7zM11 11h6v2h-6zM7 15h2v2H7zM11 15h6v2h-6z"/>
                    </svg>
                    Master Data Files
                </h2>
                <p class="table-subtitle">Filter, sort, and export your business data</p>
            </div>
            <div class="table-content">
                <div class="table-tabs">
                    <button class="tab-button active" data-table="sales">Sales Master</button>
                    <button class="tab-button" data-table="customers">Customer Master</button>
                    <button class="tab-button" data-table="rfm">RFM Segmentation</button>
                    <button class="tab-button" data-table="blacklist">Message Blacklist</button>
                    <button class="tab-button" data-table="balance">Customers w/ Balance</button>
                    <button class="tab-button" data-table="weather">Weather Master</button>
                </div>

                <!-- Summary Stats Panel -->
                <div id="stats-panel" class="stats-panel" style="display: none;">
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div class="stat-card" style="padding: 0.75rem;">
                            <div class="stat-value" id="total-records" style="font-size: 1.25rem;">-</div>
                            <div class="stat-label" style="font-size: 0.75rem;">Total Records</div>
                        </div>
                        <div class="stat-card" style="padding: 0.75rem;">
                            <div class="stat-value" id="filtered-records" style="font-size: 1.25rem;">-</div>
                            <div class="stat-label" style="font-size: 0.75rem;">Filtered Records</div>
                        </div>
                        <div class="stat-card" id="date-range-card" style="padding: 0.75rem;">
                            <div class="stat-value" id="date-range" style="font-size: 1.25rem;">-</div>
                            <div class="stat-label" style="font-size: 0.75rem;">Date Range</div>
                        </div>
                        <div class="stat-card" style="padding: 0.75rem;">
                            <div class="stat-value" id="selected-rows" style="font-size: 1.25rem;">0</div>
                            <div class="stat-label" style="font-size: 0.75rem;">Selected Rows</div>
                        </div>
                    </div>
                </div>

                <div id="table-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading data...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        class DataTableManager {
            constructor() {
                this.currentTable = 'sales';
                this.tables = {};
                this.csvData = {};
                
                // Google Apps Script web app URL - updated with your actual URL
                this.scriptUrl = 'https://script.google.com/macros/s/AKfycbzZJOxFSEj3Ue2PfdbfJ2sK8YCbDYLI4thSk9DqumhIfEx0VOAZIbwjVCBQO7Rlm2DI/exec';
                
                // Google Drive file IDs and Google Sheets IDs
                this.fileIds = {
                    sales: '1yQI0n37uXqBfy22pObBn947mSsjtVKvj',
                    customers: '15WwBn4LOgxtp3c6isn-BxGKB3BLtGxEf', 
                    rfm: '1WEMwl0qOM3Figc3adqEbz3JDx4PmLq7l',
                    blacklist: '1xp1kKfYmQet29lGKZUtnMZKd9JrOmokn',
                    balance: '1Cv1K2LezSHr3gTtmOqWiGRME1hEbvJQxkeqm8Um8Tz0', // Google Sheets
                    weather: '19xaziVGLiOaflMSKYcd7C4h6Z8KXm9AcFOV96KnhS7s'  // Google Sheets
                };
                
                // Track which files are Google Sheets vs CSV files
                this.googleSheets = ['balance', 'weather'];
                
                this.init();
            }

            init() {
                this.setupTabs();
                this.loadTable('sales');
            }

            setupTabs() {
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tableType = e.target.dataset.table;
                        this.switchTab(tableType);
                    });
                });
            }

            switchTab(tableType) {
                // Update active tab
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-table="${tableType}"]`).classList.add('active');
                
                // Clear any existing filters and search functions
                this.clearAllFilters(this.currentTable);
                
                this.currentTable = tableType;
                this.loadTable(tableType);
            }

            clearAllFilters(tableType) {
                if (this.tables[tableType]) {
                    // Clear DataTable searches
                    this.tables[tableType].search('').columns().search('').draw();
                }
                
                // Clear custom date search functions
                $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(function(fn) {
                    return !fn._tableType || fn._tableType !== tableType;
                });
                
                // Clear filter inputs
                $(`[id^="filter-${tableType}-"]`).val('');
                
                // Reset quick date filter buttons
                $('.quick-filter-btn').removeClass('active');
            }

            async loadTable(tableType) {
                const container = document.getElementById('table-container');
                
                try {
                    // Show loading
                    container.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading ${this.getTableName(tableType)}...</p>
                        </div>
                    `;

                    // Destroy existing DataTable if it exists
                    if (this.tables[tableType]) {
                        this.tables[tableType].destroy();
                    }

                    // Use Google Apps Script as secure middleware
                    const isSheet = this.googleSheets.includes(tableType);
                    const csvUrl = `${this.scriptUrl}?fileId=${this.fileIds[tableType]}&sheet=${isSheet}`;
                    
                    console.log(`Fetching via Google Apps Script: ${csvUrl}`);
                    const response = await fetch(csvUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const csvText = await response.text();
                    console.log(`Response for ${tableType}:`, csvText.substring(0, 200) + '...');
                    
                    if (!csvText || csvText.trim() === '') {
                        throw new Error('Empty response from server');
                    }
                    
                    if (csvText.startsWith('Error:')) {
                        throw new Error(csvText);
                    }
                    if (!response.ok) {
                        throw new Error(`Failed to fetch data: ${response.status}`);
                    }
                    
                    const data = this.parseCSV(csvText, tableType);
                    
                    // Store data
                    this.csvData[tableType] = data;
                    
                    // Create table
                    this.createDataTable(tableType, data);
                    
                } catch (error) {
                    console.error('Error loading table:', error);
                    container.innerHTML = `
                        <div class="error">
                            <h3>Error Loading Data</h3>
                            <p>Failed to load ${this.getTableName(tableType)}: ${error.message}</p>
                            <button onclick="dataTableManager.loadTable('${tableType}')" style="
                                background: var(--primary-blue);
                                color: white;
                                border: none;
                                padding: 0.5rem 1rem;
                                border-radius: 0.25rem;
                                cursor: pointer;
                                margin-top: 1rem;
                            ">Retry</button>
                        </div>
                    `;
                }
            }

            parseCSV(csvText, tableType) {
                // Determine separator based on table type
                const separator = tableType === 'customers' ? ';' : ',';
                
                const lines = csvText.trim().split('\n');
                const headers = this.parseCSVLine(lines[0], separator).map(h => h.replace(/"/g, '').trim());
                
                // Filter out unwanted columns for sales table
                let filteredHeaders = headers;
                let excludeIndices = [];
                
                if (tableType === 'sales') {
                    const excludeColumns = ['Comprovante_cartao', 'Bandeira_Cartao', 'Loja'];
                    excludeIndices = excludeColumns.map(col => headers.indexOf(col)).filter(index => index !== -1);
                    filteredHeaders = headers.filter((_, index) => !excludeIndices.includes(index));
                }
                
                const rows = lines.slice(1).map(line => {
                    const values = this.parseCSVLine(line, separator);
                    const row = {};
                    
                    // Filter values for sales table
                    const filteredValues = tableType === 'sales' 
                        ? values.filter((_, index) => !excludeIndices.includes(index))
                        : values;
                    
                    filteredHeaders.forEach((header, index) => {
                        let value = filteredValues[index];
                        
                        // Handle different value types properly
                        if (value === null || value === undefined) {
                            value = '';
                        } else if (value === 'null' || value === 'undefined') {
                            value = '';
                        } else {
                            // Convert to string and trim
                            const strValue = String(value).trim();
                            
                            if (strValue === '' || strValue === 'undefined' || strValue === 'null') {
                                // For weather data, convert empty precipitation/temperature/humidity to "0"
                                if (tableType === 'weather' && this.isNumericWeatherColumn(header)) {
                                    value = '0';
                                } else {
                                    value = '';
                                }
                            } else if (strValue === '0' || strValue === '0.0' || parseFloat(strValue) === 0) {
                                value = '0';
                            } else {
                                value = strValue;
                            }
                        }
                        
                        // Format dates if detected
                        if (this.isDateColumn(header) && value && value !== '' && value !== '0') {
                            value = this.formatDate(value);
                        }
                        
                        row[header] = value;
                    });
                    return row;
                });
                
                return { headers: filteredHeaders, rows };
            }

            isDateColumn(header) {
                const dateColumns = ['Data_Hora', 'Data Medicao', 'lastContactDate', 'date', 'data'];
                return dateColumns.some(col => header.toLowerCase().includes(col.toLowerCase()));
            }

            isNumericWeatherColumn(header) {
                const numericColumns = ['PRECIPITACAO', 'TEMPERATURA', 'UMIDADE'];
                return numericColumns.some(col => header.toUpperCase().includes(col));
            }

            formatDate(dateString) {
                try {
                    // Handle various date formats
                    let date;
                    
                    if (dateString.includes('-')) {
                        // YYYY-MM-DD or YYYY-MM-DD HH:MM:SS format
                        date = new Date(dateString);
                    } else if (dateString.includes('/')) {
                        // Already in DD/MM/YYYY format
                        return dateString;
                    } else {
                        return dateString;
                    }
                    
                    if (isNaN(date.getTime())) {
                        return dateString;
                    }
                    
                    // Format to DD/MM/YYYY HH:MM:SS
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    
                    return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
                } catch (error) {
                    return dateString;
                }
            }

            getColumnDefs(headers) {
                const columnDefs = [];
                
                headers.forEach((header, index) => {
                    if (this.isDateColumn(header)) {
                        columnDefs.push({
                            targets: index + 1, // +1 for checkbox column
                            type: 'date',
                            render: function(data, type, row) {
                                if (type === 'sort' || type === 'type') {
                                    // Convert DD/MM/YYYY HH:MM:SS to sortable format
                                    if (data && data.includes('/')) {
                                        const parts = data.split(' ');
                                        const datePart = parts[0].split('/');
                                        const timePart = parts[1] || '00:00:00';
                                        // Return YYYY-MM-DD HH:MM:SS for sorting
                                        return `${datePart[2]}-${datePart[1]}-${datePart[0]} ${timePart}`;
                                    }
                                    return data;
                                }
                                return data;
                            }
                        });
                    }
                });
                
                return columnDefs;
            }

            addColumnFilters(tableType, tableId, headers) {
                // Get the DataTable instance
                const table = this.tables[tableType];
                if (!table) {
                    console.error('Table not found for filters');
                    return;
                }
                
                // Clear existing filters to prevent duplication
                $('#stats-panel .column-filters').remove();
                $('#stats-panel .quick-filters').remove();
                
                // Create filter container in stats panel area
                const filterContainer = $(`
                    <div class="column-filters" style="margin-top: 1rem; padding: 1rem; background: transparent; border-radius: 0.5rem;">
                        <div class="filter-inputs" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"></div>
                    </div>
                `);
                
                const filterInputs = filterContainer.find('.filter-inputs');
                
                headers.forEach((header, index) => {
                    const inputId = `filter-${tableType}-${index}`;
                    filterInputs.append(`
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 0.25rem;">${header}</label>
                            <input type="text" id="${inputId}" 
                                   placeholder="Filter ${header}" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem;">
                            ${this.isDateColumn(header) ? '<small style="color: #6b7280;">Format: DD/MM/YYYY</small>' : ''}
                        </div>
                    `);
                });
                
                // Insert filter container in stats panel area
                $('#stats-panel').append(filterContainer);
                
                // Add event listeners after container is in DOM
                headers.forEach((header, index) => {
                    const inputId = `filter-${tableType}-${index}`;
                    $(`#${inputId}`).on('keyup change', function() {
                        const searchValue = this.value;
                        console.log(`Filtering column ${index + 1} with: ${searchValue}`); // +1 for checkbox column
                        table.column(index + 1).search(searchValue).draw();
                    });
                });
            }

            addQuickFilters(tableType, data) {
                const hasDateColumn = data.headers.some(header => this.isDateColumn(header));
                if (!hasDateColumn) return;

                const quickFilters = $(`
                    <div class="quick-filters" style="margin-top: 1.5rem;">
                        <span style="font-weight: 500; margin-right: 1rem;">Quick Date Filters:</span>
                        <button class="quick-filter-btn" data-days="7">Last 7 Days</button>
                        <button class="quick-filter-btn" data-days="30">Last 30 Days</button>
                        <button class="quick-filter-btn" data-days="90">Last 90 Days</button>
                        <button class="quick-filter-btn" data-clear="true">Clear</button>
                    </div>
                `);

                $('#stats-panel .column-filters').after(quickFilters);

                quickFilters.find('.quick-filter-btn').on('click', (e) => {
                    const btn = $(e.target);
                    const days = btn.data('days');
                    const clear = btn.data('clear');

                    // Remove active class from all buttons
                    quickFilters.find('.quick-filter-btn').removeClass('active');

                    // Clear existing search functions for this table
                    $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(function(fn) {
                        return !fn._tableType || fn._tableType !== tableType;
                    });

                    if (clear) {
                        this.tables[tableType].search('').columns().search('').draw();
                    } else {
                        btn.addClass('active');
                        this.applyDateFilter(tableType, days, data.headers);
                    }
                });
            }

            applyDateFilter(tableType, days, headers) {
                const dateColumnIndex = headers.findIndex(header => this.isDateColumn(header));
                if (dateColumnIndex === -1) return;

                const targetDate = new Date();
                targetDate.setDate(targetDate.getDate() - days);

                // Create a unique search function for this table
                const searchFunction = function(settings, data, dataIndex) {
                    if (settings.nTable.id !== `table-${tableType}`) return true;
                    
                    const dateStr = data[dateColumnIndex + 1]; // +1 for checkbox column
                    if (!dateStr || dateStr === '') return false;
                    
                    // Parse DD/MM/YYYY format
                    const dateParts = dateStr.split(' ')[0].split('/');
                    if (dateParts.length !== 3) return false;
                    
                    const rowDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    return rowDate >= targetDate;
                };

                // Store reference to remove later
                searchFunction._tableType = tableType;
                $.fn.dataTable.ext.search.push(searchFunction);
                this.tables[tableType].draw();
            }

            addRowSelection(tableType, tableId) {
                // Select all checkbox
                $(`#select-all-${tableType}`).on('change', function() {
                    const checked = this.checked;
                    $(`#${tableId} .row-select:visible`).prop('checked', checked);
                    dataTableManager.updateSelectedCount(tableType);
                });

                // Individual row checkboxes
                $(`#${tableId}`).on('change', '.row-select', function() {
                    $(this).closest('tr').toggleClass('selected-row', this.checked);
                    dataTableManager.updateSelectedCount(tableType);
                });
            }

            addColumnHighlighting(tableId) {
                $(`#${tableId} thead th`).on('click', function() {
                    const columnIndex = $(this).index();
                    
                    // Remove previous highlights
                    $(`#${tableId} td`).removeClass('column-highlight');
                    
                    // Highlight clicked column
                    $(`#${tableId} tbody tr`).each(function() {
                        $(this).find('td').eq(columnIndex).addClass('column-highlight');
                    });
                });
            }

            showStatsPanel(tableType, data) {
                $('#stats-panel').show();
                
                // Hide date range for certain tabs
                const hideDateRangeTabs = ['rfm', 'blacklist', 'balance'];
                if (hideDateRangeTabs.includes(tableType)) {
                    $('#date-range-card').hide();
                } else {
                    $('#date-range-card').show();
                }
                
                this.updateStats(tableType, data);
            }

            updateStats(tableType, data) {
                const table = this.tables[tableType];
                if (!table) return;

                const totalRecords = data.rows.length;
                const filteredRecords = table.rows({search: 'applied'}).count();
                const selectedRows = $(`#table-${tableType} .row-select:checked`).length;

                // Update stats
                $('#total-records').text(totalRecords.toLocaleString());
                $('#filtered-records').text(filteredRecords.toLocaleString());
                $('#selected-rows').text(selectedRows);

                // Calculate date range if applicable
                const dateColumn = data.headers.find(header => this.isDateColumn(header));
                if (dateColumn) {
                    const dates = data.rows
                        .map(row => row[dateColumn])
                        .filter(date => date && date !== '' && date !== '0')
                        .map(dateStr => {
                            // Convert DD/MM/YYYY to sortable format for comparison
                            if (dateStr.includes('/')) {
                                const parts = dateStr.split(' ')[0].split('/');
                                return new Date(parts[2], parts[1] - 1, parts[0]);
                            }
                            return new Date(dateStr);
                        })
                        .filter(date => !isNaN(date.getTime()))
                        .sort((a, b) => a - b);
                    
                    if (dates.length > 0) {
                        const oldest = dates[0].toLocaleDateString('pt-BR');
                        const newest = dates[dates.length - 1].toLocaleDateString('pt-BR');
                        $('#date-range').text(`${oldest} - ${newest}`);
                    }
                } else {
                    $('#date-range').text('N/A');
                }
            }

            updateSelectedCount(tableType) {
                const selectedRows = $(`#table-${tableType} .row-select:checked`).length;
                $('#selected-rows').text(selectedRows);
            }

            parseCSVLine(line, separator = ',') {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === separator && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current.trim());
                // Don't remove quotes from values to preserve formatting
                return result.map(val => val.replace(/^"|"$/g, ''));
            }

            createDataTable(tableType, data) {
                const container = document.getElementById('table-container');
                
                // Create table HTML with row selection
                const tableId = `table-${tableType}`;
                container.innerHTML = `
                    <table id="${tableId}" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-${tableType}" class="select-checkbox"></th>
                                ${data.headers.map(header => `<th>${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.rows.map((row, index) => 
                                `<tr><td><input type="checkbox" class="select-checkbox row-select" data-row="${index}"></td>${data.headers.map(header => `<td>${row[header] || ''}</td>`).join('')}</tr>`
                            ).join('')}
                        </tbody>
                    </table>
                `;

                // Initialize DataTable with enhanced features
                this.tables[tableType] = $(`#${tableId}`).DataTable({
                    responsive: true,
                    pageLength: 25,
                    lengthMenu: [[25, 50, 100], [25, 50, 100]],
                    dom: 'Blfrtip',
                    buttons: [
                        'copy',
                        {
                            extend: 'csv',
                            title: `Lavpop_${this.getTableName(tableType)}_${new Date().toISOString().split('T')[0]}`,
                            filename: `Lavpop_${this.getTableName(tableType)}_${new Date().toISOString().split('T')[0]}`,
                            fieldSeparator: ';',
                            fieldBoundary: '"',
                            exportOptions: {
                                columns: ':not(:first-child)' // Skip checkbox column
                            }
                        },
                        {
                            extend: 'excel',
                            title: `Lavpop_${this.getTableName(tableType)}_${new Date().toISOString().split('T')[0]}`,
                            filename: `Lavpop_${this.getTableName(tableType)}_${new Date().toISOString().split('T')[0]}`,
                            exportOptions: {
                                columns: ':not(:first-child)', // Skip checkbox column
                                format: {
                                    body: function(data, row, column, node) {
                                        // Preserve decimal commas for numeric values
                                        if (typeof data === 'string' && data.match(/^\d+,\d+$/)) {
                                            return '"' + data + '"';
                                        }
                                        return data;
                                    }
                                }
                            }
                        },
                        {
                            extend: 'pdf',
                            title: `Lavpop - ${this.getTableName(tableType)} - ${new Date().toLocaleDateString()}`,
                            filename: `Lavpop_${this.getTableName(tableType)}_${new Date().toISOString().split('T')[0]}`,
                            orientation: 'landscape',
                            pageSize: 'A3',
                            exportOptions: {
                                columns: ':not(:first-child)' // Skip checkbox column
                            },
                            customize: function(doc) {
                                doc.defaultStyle.fontSize = 6;
                                doc.styles.tableHeader.fontSize = 7;
                                doc.styles.tableHeader.fillColor = '#10306b';
                                doc.content[1].table.widths = Array(doc.content[1].table.body[0].length).fill('*');
                                doc.pageMargins = [10, 40, 10, 30];
                            }
                        },
                        {
                            extend: 'print',
                            title: `Lavpop - ${this.getTableName(tableType)} - ${new Date().toLocaleDateString()}`,
                            exportOptions: {
                                columns: ':not(:first-child)' // Skip checkbox column
                            }
                        }
                    ],
                    order: [[1, 'desc']], // Skip checkbox column
                    scrollX: true,
                    columnDefs: this.getColumnDefs(data.headers),
                    language: {
                        search: "Search:",
                        lengthMenu: "Show _MENU_ entries per page",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoEmpty: "No entries found",
                        infoFiltered: "(filtered from _MAX_ total entries)",
                        paginate: {
                            first: "First",
                            last: "Last", 
                            next: "Next",
                            previous: "Previous"
                        }
                    },
                    drawCallback: () => this.updateStats(tableType, data)
                });

                // Add enhanced features
                this.addColumnFilters(tableType, tableId, data.headers);
                this.addQuickFilters(tableType, data);
                this.addRowSelection(tableType, tableId);
                this.addColumnHighlighting(tableId);
                this.showStatsPanel(tableType, data);
            }

            getTableName(tableType) {
                const names = {
                    sales: 'Sales Master',
                    customers: 'Customer Master', 
                    rfm: 'RFM Segmentation',
                    blacklist: 'Message Blacklist',
                    balance: 'Customers with Balance',
                    weather: 'Weather Master'
                };
                return names[tableType] || tableType;
            }
        }

        // Initialize when page loads
        let dataTableManager;
        document.addEventListener('DOMContentLoaded', function() {
            dataTableManager = new DataTableManager();
        });
    </script>
</body>
</html>
